<?xml version="1.0" encoding="UTF-8"?>
<project name="Wise-core" default="integrationTest" basedir="../../">

	<import file="${basedir}/builder/ant-import/build-setup.xml" />
	<property name="wswar.output.dir" value="${build.dir}/webservice-wars" />

	<path id="test.execution.classpath">
		<pathelement location="${coverage.dir}/instrumentedClasses" />
		<pathelement location="${basedir}/${classes.dir}" />
		<pathelement location="${basedir}/${test.classes.dir}" />
		<pathelement location="${test.resources.dir}" />
		<pathelement location="${test.output.dir}" />
		<path refid="build.classpath" />
		<path refid="test.build.classpath" />
		<pathelement location="${env.JAVA_HOME}/lib/tools.jar" />
		<pathelement location="${lib.dir}" />
		<pathelement location="${test.lib.dir}" />
	</path>

	<target name="clean" description="Cleans up the build directory">
		<delete dir="${test.classes.dir}" />
	</target>

	<target name="init" description="Initialize the build">
		<mkdir dir="${test.classes.dir}" />
		<deltree dir="${test.output.dir}" />
		<mkdir dir="${test.output.dir}" />

	</target>

	<target name="build-test-wars" description="Build the test war for deployments">
		<mkdir dir="${wswar.output.dir}" />
		<war warfile="${wswar.output.dir}/basic.war" webxml="${test.resources.dir}/integration/test/basic/WEB-INF/web.xml">
			<classes dir="${test.classes.dir}">
				<include name="it/javalinux/wise/test/integraton/basic/**/*.class" />
				<include name="it/javalinux/wise/test/integraton/basic/**/*.xml" />
			</classes>
		</war>
	</target>
	<target name="compileTest" depends="init,build-test-wars">
		<ant antfile="${main.builder}" target="compile" />
		<javac destdir="${test.classes.dir}" classpathref="test.execution.classpath" debug="${javac.debug}" deprecation="${javac.deprecation}" nowarn="on" target="1.5">
			<src path="${src.test.dir}" />
			<include name="**/integration/**" />
		</javac>
	</target>

	<target name="integrationTest" depends="compileTest">
		<input
		    message="Have you a JBoss instance up and running? Press Enter to continue..."
		  />
		<junit printsummary="yes" haltonfailure="yes">
			<classpath refid="test.execution.classpath" />
			<batchtest fork="yes" todir="${test.output.dir}">
				<formatter type="plain" />
				<fileset dir="${src.test.dir}">
					<include name="**/integration/**/*Test.java" />
				</fileset>
			</batchtest>
		</junit>
		<echo>You can now stop you JBoss instance.</echo>
	</target>

</project>
